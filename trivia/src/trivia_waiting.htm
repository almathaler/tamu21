<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="waiting.css">
    <title>IceToMeetYou Trivia | Waiting...</title>
  </head>
  <body>
    <div class="submitted">
      <h1 id="thx"></h1><br>
      <h2>Waiting for your compatriots...</h2><br>
      <img src="zebra.png" id="avatar_pic"/>
    </div>
    <!-- scrapes form info from url -->
    <script>
      const queryString = window.location.search;
      console.log(queryString);

      const urlParams = new URLSearchParams(queryString);
      const name = urlParams.get('name')
      console.log(name);
      document.getElementById('thx').innerHTML = "Thank you, " + name + "!";

      const major = urlParams.get('major')
      console.log(major);

      const from = urlParams.get('from')
      console.log(from);

      const movie = urlParams.get('movie')
      console.log(movie);

      const grade = urlParams.get('grade')
      console.log(grade);

      const avatar = urlParams.get('avatar')
      console.log(avatar);
      if (avatar.valueOf() == "sloth"){
        document.getElementById('avatar_pic').src = "sloth.png";
      }
      if (avatar.valueOf() == "penguin"){
        document.getElementById('avatar_pic').src = "penguin.png";
      }


    </script>
    <div class="joiners" id="joiners">
    </div>
  </body>
  <!-- pubnub stuff. No messages, just presence -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.27.4.min.js"></script>

  <script>
    const messagesTop = document.getElementById('joiners');

    const clientUUID = PubNub.generateUUID();
    const theChannel = 'the_guide';
    const theEntry = 'Earth';

    const pubnub = new PubNub({
      // replace the following with your own publish and subscribe keys
      publishKey: 'pub-c-460f7f1a-94c8-4637-a61a-73822f90499b',
      subscribeKey: 'sub-c-79b78544-636e-11eb-921d-66294e2030b5',
      uuid: clientUUID
    });

    pubnub.addListener({
      message: function(event) {
          displayMessage('[NAME: recieved]', event.message.entry + ': ' + event.message.update);
      },
      presence: function(event) {
        const urlParams = new URLSearchParams(queryString);
        const name = urlParams.get('name')
        submitName("test", name.valueOf());
      },

    });

    pubnub.subscribe({
      channels: ['the_guide'],
      withPresence: true
    });

    submitName = function(anEntry, aName) {
      pubnub.publish({
        channel : theChannel,
        message : {'entry' : anEntry, 'update' : aName}
      },
      function(status, response) {
        if (status.error) {
          console.log(status)
        }
        // else {
        //   displayMessage('[NAME: sent]',
        //     'timetoken: ' + response.timetoken);
        // }
      });
    };

    displayMessage = function(messageType, aMessage) {
      let pmessage = document.createElement('p');
      //let br = document.createElement('br');

      messagesTop.after(pmessage);
      // pmessage.appendChild(document.createTextNode(messageType));
      // pmessage.appendChild(br);
      pmessage.appendChild(document.createTextNode(aMessage));
    }
  </script>
</html>
