<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Hello, PubNub</title>
    <!-- Update this block with the URL to the content delivery network version of the SDK -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.11.js"></script>
</head>
<body>
  <div id="enterName">
    <label for="username">Enter name</label><br>
    <input type="text" id="username" name="username">
    <button onClick="joinGame(document.getElementById('username'))">Join</button>
  </div>
  <div id="chat">
    <h2>Chat</h2>
    <div id="send_messages">
      <input type="text" id="msg">
      <button onClick="sendMessageButton(document.getElementById('msg'))">Send</button><br>
    </div>
    <button onClick="leave()">Leave</button>
    <div id="messages">
    </div>
  </div>

    <script>
    const CHAT_CHANNEL = "chat_test4";
    const CONTROL_CHANNEL = "control_test4";
    const messagesTop = document.getElementById("messages");

    var playerNum = 0;
    var isHost = false;
    var playerName;

    function joinGame(nameInput) {
      if (nameInput.value === "")
        return;

      playerName = nameInput.value;
      nameInput.value = "";

      pubnub = new PubNub({
          publishKey : "pub-c-8a3ef9c7-adec-4424-abbd-42f099243469",
          subscribeKey : "sub-c-16588e62-6341-11eb-8d92-92d9cc8397ac",
          uuid: playerName
      })

      pubnub.addListener({
          status: function(statusEvent) {
              if (statusEvent.category === "PNConnectedCategory") {
                pubnub.hereNow({
                  channels: [CHAT_CHANNEL]
                }, function (status, response) {
                  console.log(status, response);
                });
              }
          },
          presence: function(response) {//assigns player numbers and host
              if (response.action === 'join') {
                if (response.occupancy < 2) {//first in room
                  isHost = true;
                  playerNum = 1;
                } else {
                  if (!isHost) {
                    playerNum = response.occupancy;
                  }
                }

                if (playerNum === response.occupancy) {//checks you joined the room
                  alert(playerName + " has joined the room");
                }
              }
          },
          message: function(response) {//interprets the messages
            let msg = response.message;

            if (msg.type === 'unsubscribe') {
              pubnub.unsubscribe({
                channel: msg.channel
              });
            } else if (msg.type === 'unsubscribe-all') {
              pubnub.unsubscribeAll();
            } else if (msg.type === "sent_message") {
              printMessage(msg);
            } else if (msg.type === "alert_message") {
              printAlertMessage(msg);
            }
          }
      })

      pubnub.subscribe({//main chat channel
        channels: [CHAT_CHANNEL],
        withPresence: true,
      });

      pubnub.subscribe({//forces users to unsubscribe
        channels: [CONTROL_CHANNEL]
      });
    }

    function sendMessageButton(msgInput) {//called by the button to send message
        sendMessage(msgInput.value);
        msgInput.value = "";
    }

    function sendMessage(msg) {//sends message to chat
      var publishPayload = {
          channel: CHAT_CHANNEL,
          message: {
              type: "sent_message",
              sender: playerName,
              content: msg
          }
      }
      pubnub.publish(publishPayload, function(status, response) {
        if (status.error) {
          console.log(status, response);
        }
      })
    }

    function alert(msg) {
      var publishPayload = {
          channel: CHAT_CHANNEL,
          message: {
              type: "alert_message",
              content: msg
          }
      }
      pubnub.publish(publishPayload, function(status, response) {
        if (status.error) {
          console.log(status, response);
        }
      })
    }

    function printMessage(msg) {//prints message to stream
      let pmessage = document.createElement("p");
      messagesTop.after(pmessage);

      let bold = document.createElement("b");
      bold.appendChild(document.createTextNode(msg.sender))
      pmessage.appendChild(bold);

      pmessage.appendChild(document.createElement("br"));
      pmessage.appendChild(document.createTextNode(msg.content));
    }

    function printAlertMessage(msg) {//prints message to stream
      let pmessage = document.createElement("p");
      messagesTop.after(pmessage);

      let bold = document.createElement("i");
      bold.appendChild(document.createTextNode(msg.content))
      pmessage.appendChild(bold);
    }

    function leave() {//unsubscribes all
      alert("The chat has ended for all");

      pubnub.publish({
        channel: CONTROL_CHANNEL,
        message: {
          type: "unsubscribe-all"
        }
      });
    }

    </script>
</body>
</html>
